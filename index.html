<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>驗證中...</title>
    <style>
        body {
            font-family: 'Microsoft YaHei', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .container {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .details {
            font-size: 14px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="spinner"></div>
        <div class="status" id="status">正在收集裝置資訊...</div>
        <div class="details" id="details">請稍候，這可能需要幾秒鐘</div>
    </div>

    <script>
        // 收集詳細的裝置資訊
        async function collectDeviceInfo() {
            const info = {
                // 基本資訊
                timestamp: new Date().toISOString(),
                userAgent: navigator.userAgent,
                language: navigator.language,
                languages: navigator.languages?.join(',') || '',
                platform: navigator.platform,
                cookieEnabled: navigator.cookieEnabled,
                doNotTrack: navigator.doNotTrack,
                
                // 螢幕資訊
                screenWidth: screen.width,
                screenHeight: screen.height,
                screenColorDepth: screen.colorDepth,
                screenPixelDepth: screen.pixelDepth,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight,
                
                // 時區資訊
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                timezoneOffset: new Date().getTimezoneOffset(),
                
                // 連線資訊
                connectionType: navigator.connection?.effectiveType || 'unknown',
                connectionDownlink: navigator.connection?.downlink || 'unknown',
                
                // 硬體資訊
                hardwareConcurrency: navigator.hardwareConcurrency || 'unknown',
                deviceMemory: navigator.deviceMemory || 'unknown',
                
                // 瀏覽器功能
                webglSupported: false,
                webglVendor: '',
                webglRenderer: '',
                
                // 其他
                referrer: document.referrer,
                currentUrl: window.location.href
            };

            // WebGL 資訊收集
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                if (gl) {
                    info.webglSupported = true;
                    const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                    if (debugInfo) {
                        info.webglVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                        info.webglRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                    }
                }
            } catch (e) {
                console.log('WebGL 資訊收集失敗:', e);
            }


            // 獲取更準確的IP資訊（透過WebRTC）
            try {
                const localIPs = await getLocalIPs();
                info.localIPs = localIPs.join(',');
            } catch (e) {
                info.localIPs = 'unavailable';
            }

            return info;
        }

        // 透過WebRTC獲取本地IP
        function getLocalIPs() {
            return new Promise((resolve) => {
                const ips = [];
                const RTCPeerConnection = window.RTCPeerConnection || 
                                        window.mozRTCPeerConnection || 
                                        window.webkitRTCPeerConnection;
                
                if (!RTCPeerConnection) {
                    resolve([]);
                    return;
                }

                const pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });

                pc.createDataChannel('');
                pc.onicecandidate = (e) => {
                    if (e.candidate) {
                        const candidate = e.candidate.candidate;
                        const ipMatch = candidate.match(/(\d+\.\d+\.\d+\.\d+)/);
                        if (ipMatch && !ips.includes(ipMatch[1])) {
                            ips.push(ipMatch[1]);
                        }
                    }
                };

                pc.createOffer().then(offer => pc.setLocalDescription(offer));
                
                setTimeout(() => {
                    pc.close();
                    resolve(ips);
                }, 2000);
            });
        }

        // 主要執行函數
        document.addEventListener("DOMContentLoaded", async function () {
            const statusEl = document.getElementById('status');
            const detailsEl = document.getElementById('details');
            
            try {
                statusEl.textContent = '正在收集裝置資訊...';
                detailsEl.textContent = '分析硬體特徵';
                
                const deviceInfo = await collectDeviceInfo();
                
                statusEl.textContent = '正在傳送資料...';
                detailsEl.textContent = '驗證裝置身份';
                
                const response = await fetch("/api/forward", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(deviceInfo)
                });
                
                const result = await response.text();
                console.log("伺服器回應:", result);
                
                statusEl.textContent = '驗證完成';
                detailsEl.textContent = '裝置資訊已記錄';
                
                // 3秒後可能重導向或顯示其他內容
                setTimeout(() => {
                    statusEl.textContent = '系統準備就緒';
                    detailsEl.textContent = '歡迎使用';
                }, 2000);
                
            } catch (error) {
                console.error("錯誤:", error);
                statusEl.textContent = '驗證失敗';
                detailsEl.textContent = '請重新整理頁面';
            }
        });
    </script>
</body>
</html>
